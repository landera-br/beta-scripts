<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
	function initMap(lat = -23.543228744218986, lng = -46.64185219146712) {
		// Custom map style
		var customMapStyle = [
			{
				elementType: 'geometry',
				stylers: [
					{
						color: '#36475c',
					},
				],
			},
			{
				elementType: 'labels.text.fill',
				stylers: [
					{
						color: '#ffffff',
					},
				],
			},
			{
				elementType: 'labels.text.stroke',
				stylers: [
					{
						color: '#000000',
					},
					{
						weight: 1,
					},
				],
			},
			{
				featureType: 'administrative.locality',
				elementType: 'labels.text.fill',
				stylers: [
					{
						color: '#e1e1e1',
					},
				],
			},
			{
				featureType: 'road',
				elementType: 'geometry',
				stylers: [
					{
						color: '#2e394b',
					},
				],
			},
			{
				featureType: 'road',
				elementType: 'geometry.stroke',
				stylers: [
					{
						color: '#212a37',
					},
				],
			},
			{
				featureType: 'road',
				elementType: 'labels.text.fill',
				stylers: [
					{
						color: '#ffffff', // Improved road labels text fill color
					},
				],
			},
			{
				featureType: 'road.arterial', // Target road arterials (avenues)
				elementType: 'geometry',
				stylers: [
					{
						color: '#485a6f', // A color between normal streets and highways
					},
				],
			},
			{
				featureType: 'road.arterial', // Target road arterials (avenues)
				elementType: 'labels.text.fill',
				stylers: [
					{
						color: '#ffffff', // Text fill color for avenues
					},
				],
			},
			{
				featureType: 'road.highway',
				elementType: 'geometry',
				stylers: [
					{
						color: '#717c9f',
					},
				],
			},
			{
				featureType: 'road.highway',
				elementType: 'geometry.stroke',
				stylers: [
					{
						color: '#1f2835',
					},
				],
			},
			{
				featureType: 'road.highway',
				elementType: 'labels.text.fill',
				stylers: [
					{
						color: '#ffffff', // Improved highway labels text fill color
					},
				],
			},
			{
				featureType: 'poi',
				elementType: 'labels',
				stylers: [
					{
						visibility: 'off',
					},
				],
			},
			{
				featureType: 'poi.park', // Target parks specifically
				elementType: 'geometry',
				stylers: [
					{
						hue: '#075E54', // Set the color to green
					},
				],
			},
			{
				featureType: 'poi.park', // Target parks specifically
				elementType: 'labels.icon',
				stylers: [
					{
						visibility: 'on', // Show park icons
					},
				],
			},
			{
				featureType: 'poi.park', // Target parks specifically
				elementType: 'labels.text',
				stylers: [
					{
						visibility: 'on', // Show park labels
					},
				],
			},
			{
				featureType: 'transit',
				elementType: 'geometry',
				stylers: [
					{
						color: '#5b6b80',
					},
				],
			},
			{
				featureType: 'transit.station',
				elementType: 'labels.text.fill',
				stylers: [
					{
						color: '#e1e1e1',
					},
				],
			},
			{
				featureType: 'water',
				elementType: 'geometry',
				stylers: [
					{
						color: '#1e3579',
					},
				],
			},
			{
				featureType: 'water',
				elementType: 'labels.text.fill',
				stylers: [
					{
						color: '#ffffff',
					},
				],
			},
			{
				featureType: 'water',
				elementType: 'labels.text.stroke',
				stylers: [
					{
						color: '#000000',
					},
					{
						weight: 1,
					},
				],
			},
		];

		// Map options
		var options = {
			zoom: 15,
			center: { lat, lng },
			styles: customMapStyle,
			mapTypeControl: false,
		};

		// New map
		var map = new google.maps.Map(document.getElementById('map'), options);

		// Add marker
		var marker = new google.maps.Marker({
			map: map,
			icon: 'https://uploads-ssl.webflow.com/64773d761bc76753239357f0/6504650323fbdfa3e6f51a95_1.png',
			position: { lat, lng },
		});

		$('#typing').hide();
	}

	let lat;
	let lng;

	// Check if the Geolocation API is available in the browser
	if ('geolocation' in navigator) {
		// Get the user's location
		navigator.geolocation.getCurrentPosition(function (position) {
			// Retrieve latitude and longitude
			lat = position.coords.latitude;
			lng = position.coords.longitude;

			initMap(lat, lng);
		});
	} else {
		// Geolocation is not available in this browser
		console.log('Geolocation is not available in this browser.');
	}
</script>
<!-- Load the Google Maps JS API -->
<script
	async
	defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJHQcfM6vogqPfjTxzw-5KAt_qvOcsZl4"
></script>
<script>
	$(document).ready(async function () {
		$('#message-input').attr('autocomplete', 'off');

		$('#btn-reset').click(function () {
			$('#chat').empty();
			$('#typing').hide();
		});
	});

	var form = $('#message-form');

	form.submit(async function (event) {
		event.preventDefault();
		var input = $('#message-input').val();

		if (input === '') return;

		// Disable input
		$('#message-input').prop('disabled', true);

		// Append input to chat
		$('#chat').append(`<div class="user-message">${input}</div>`);

		// Clear input
		$('#message-input').val('');

		// Show typing indicator
		$('#typing').show();

		// Scroll chat to bottom
		$('.chat-wrapper').scrollTop($('.chat-wrapper')[0].scrollHeight);

		var messages = [];

		// Iterate through child elements of #chat
		$('#chat')
			.children()
			.each(function () {
				var role = $(this).hasClass('user-message') ? 'user' : 'assistant';
				var content = $(this).text();

				// Push message to messages array
				messages.push({ role: role, content: content });
			});

		// Make request to API
		let response = await fetch('https://beta-ai-7ikj4ovbfa-uc.a.run.app/message', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({ input_message: input, chat_history: messages }),
		});

		// Wait for response
		response = await response;

		// Check if response is ok
		if (response.ok) {
			// Parse response
			response = await response.json();

			// Get response message
			var output = response.output;

			// Append response message to chat
			$('#chat').append(`<div class="ai-message">${marked.parse(output)}</div>`);

			// Scroll chat to bottom
			$('.chat-wrapper').scrollTop($('.chat-wrapper')[0].scrollHeight);

			// Enable input
			$('#message-input').prop('disabled', false);

			// Focus input
			$('#message-input').focus();

			// Hide typing indicator
			$('#typing').hide();
		} else {
			// Enable input
			$('#message-input').prop('disabled', false);

			// Focus input
			$('#message-input').focus();

			// Hide typing indicator
			$('#typing').hide();

			// Alert user
			alert('Ocorreu um erro ao enviar a mensagem. Tente novamente mais tarde.');
		}
	});

	$('.send-button').click(function (event) {
		event.preventDefault();
		form.submit();
	});
</script>
