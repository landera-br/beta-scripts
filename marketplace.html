<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Load the Google Maps JS API -->
<script
	async
	defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJHQcfM6vogqPfjTxzw-5KAt_qvOcsZl4"
></script>
<!-- Google Maps Functions -->
<script src="https://cdn.jsdelivr.net/gh/landera-br/beta-scripts@v1.85/marketplace.js"></script>
<script>
	$(document).ready(async function () {
		$('#message-input').attr('autocomplete', 'off');

		$('#btn-reset').click(function () {
			$('#chat').empty();
			$('#typing').hide();
		});
	});

	var form = $('#message-form');

	form.submit(async function (event) {
		event.preventDefault();
		let response;
		var input = $('#message-input').val();

		if (input === '') return;

		$('#message-input').prop('disabled', true);

		$('#chat').append(`<div class="user-message">${input}</div>`);

		$('#message-input').val('');

		$('#typing').show();

		$('.chat-wrapper').scrollTop($('.chat-wrapper')[0].scrollHeight);

		var messages = [];

		$('#chat')
			.children()
			.each(function () {
				var role = $(this).hasClass('user-message') ? 'user' : 'assistant';
				var content = $(this).text();

				messages.push({ role: role, content: content });
			});

		// Remove last message from messages array
		messages.pop();

		try {
			response = await fetch('https://beta-ai-7ikj4ovbfa-uc.a.run.app/message', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					input_message: input,
					chat_history: messages,
					latitude: lat,
					longitude: lng,
				}),
			});
		} catch (error) {
			alert('Ocorreu um erro ao enviar a mensagem. Tente novamente mais tarde.');

			$('#message-input').prop('disabled', false);

			$('#message-input').focus();

			$('#typing').hide();

			return;
		}

		response = await response;

		if (response.ok) {
			// Parse response
			response = await response.json();

			// Get response message
			const output = response.output;
			const query = response.search_query;
			const coordinates = response.coordinates;
			const topic = response.topic;
			const suggested_places_ids = response.suggested_places_ids;
			let markersData = response.beta_pro_markers;

			if (topic === 'recommend_services' && query) {
				// Add Google Places markers
				try {
					let response = await fetchRefresh(
						`https://beta-backend-7ikj4ovbfa-uc.a.run.app/api/v1/places/`,
						{
							method: 'POST',
							headers: {
								Accept: 'application/json',
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({ query, coordinates }),
						}
					);

					if (response.status == 200) {
						const placesResult = await response.json();

						if (placesResult) {
							// Loop through markers and add { type: 'suggested' } property
							placesResult.forEach((place) => {
								if (suggested_places_ids.includes(place.place_id)) {
									place.type = 'suggested';
								} else {
									place.type = 'basic';
								}
							});

							markersData = markersData.concat(placesResult);
							console.log(markersData);
						}
					} else {
						throw new Error();
					}
				} catch (error) {
					alert('Ocorreu um erro ao carregar mapa. Tente novamente mais tarde.');
				}
			}

			if (markersData.length !== 0) {
				// Remove duplicate markers
				cleanedMarkersData = removeDuplicateMarkers(markersData);
				clearMarkers();
				await addMarkersWithTimeout(cleanedMarkersData);
			}

			// TODO Handler product question type
			// ...

			// Append response message to chat
			$('#chat').append(`<div class="ai-message">${marked.parse(output)}</div>`);

			$('.chat-wrapper').scrollTop($('.chat-wrapper')[0].scrollHeight);

			$('#message-input').prop('disabled', false);

			$('#message-input').focus();

			$('#typing').hide();
		} else {
			$('#message-input').prop('disabled', false);

			$('#message-input').focus();

			$('#typing').hide();

			alert('Ocorreu um erro ao enviar a mensagem. Tente novamente mais tarde.');
		}
	});

	$('.send-button').click(function (event) {
		event.preventDefault();
		form.submit();
	});
</script>
